#!/bin/bash
#
# Usage:
# reload_extra_files <object key> [version ID]
#
# Downloads and installs extra runtime config files from the given object in the
# config bucket, optionally at the given version (defaults to latest).

set -e
source /var/vcap/packages/awscli/bosh/runtime.env
set -u

CONFIG_DIR=/var/vcap/jobs/haproxy/config
KEY="$1"

WORK_DIR="$(mktemp -d)"
trap 'rm -rf "${WORK_DIR}"' EXIT
cd "${WORK_DIR}"

aws s3api get-object --bucket '<%= p('config_bucket') %>' --key "${KEY}" ${2:+--version-id "$2"} config.tgz
tar xf config.tgz

BACKUP_DIR="${CONFIG_DIR}/extra-backup-$(date -Iseconds)"
mv "${CONFIG_DIR}/extra" "${BACKUP_DIR}"
mv config "${CONFIG_DIR}/extra"

if /var/vcap/jobs/haproxy/bin/haproxy_ctl test
then
	rm -rf "${BACKUP_DIR}"
else
	rm -rf "${CONFIG_DIR}/extra"
	mv "${BACKUP_DIR}" "${CONFIG_DIR}/extra"
	exit 1
fi
